define(["jquery","qlik","text!./css/style.css"],function(e,t,a){"use strict";e("<style>").html(a).appendTo("head");var r="https://biwrapper.arria.com/",n="Yml3cmFwcGVyOnc/R2NkZzdl",l=!0,i=!1,o={};function s(t,a,n){var l="";l+="/*\n",l+="* function to return standard BI format data.\n",l+="* @return  A JSON object.\n",l+="*/\n",l+="getData()",l+="\n",l+="\n",l+="/*\n",l+="* function for passing app specific dataformat\n",l+="* @param appSpecificData : The name of formatted JSON Object specific to NLG app.\n",l+="*/\n";var i="";i+='<div class="qlikContainer" id="qlikContainer'+t+'">',i+='<header style="display:block;width:100%;" id="headerLay'+t+'">',i+='<select id="drillDownFilter'+t+'" style="float:left;width:150px;border:1px solid green;margin-right:5px;"></select>',i+='<div style="float:right">',i+='<a href="javascript:void(0);" id="setting'+t+'" style="float:left"><img src="'+r+'arria/images/setting.png"></a>',i+="</div>",i+='<div class="model" id="model'+t+'" style="display:none;"><div class="model-content"><br><br><p id="modaldata'+t+'"></p><br><button type="button" id="closemodal'+t+'">Close</button></div><div class="backdrop"></div></div>',i+="</header>",i+='<section style="float:left;width:100%">',i+='<div class="narrator" id="narrator'+t+'" style="display:none">',i+='<input type="text" placeholder="Enter NLG Service URL" class="narratorUrl" id="narratorUrl'+t+'">',i+='<div class="auth">',i+='<input type="text" placeholder="Header" class="header" id="header'+t+'"><input type="text" placeholder="Authorization Key" class="authkey" id="authkey'+t+'">',i+="</div>",i+='<div class="download-section">',i+="<span>Input Dataset in JSON Format</span>",i+='<a href="javascript:void(0);" class="download" id="downloadJson'+t+'">Download</a>',i+="</div>",i+='<textarea class="jsonobject" id="jsonholder'+t+'" readonly></textarea>',i+='<p>Custom Mapping Script</p><textarea class="editor" id="editor'+t+'" placeholder="'+(l+="setData(appSpecificData)")+'"></textarea>',i+='<button type="button" class="save" id="save'+t+'">Generate Text <img class="loader" src="'+r+'arria/images/loader.gif" id="loader'+t+'"></button>',i+='<div class="copyright"><img src="'+r+'arria/images/copyright.png"></div>',i+="</div>",i+='<div class="generator" id="generator'+t+'"></div>',i+='<div id="pageloader'+t+'" class="pageloader" style="display:none;"></div><div id="overlay'+t+'" class="overlay" style="display:none;"></div>',i+='<textarea class="jsbuilderoutput" id="jsbuilderoutput'+t+'" style="display:none;"></textarea>',i+="</section>",i+="</div>",a.append(i),function(t,a){var r=e("#narratorUrl"+a).val();e("#generator"+a).html();void 0!==r&&null!==r&&""!==r.trim()||(void 0!==t.url&&null!==t.url&&""!==t.url.trim()&&e("#narratorUrl"+a).val(t.url),void 0!==t.narrator&&null!==t.narrator&&""!==t.narrator.trim()&&e("#generator"+a).html(t.narrator),void 0!==t.headerKey&&null!==t.headerKey&&""!==t.headerKey.trim()&&e("#header"+a).val(t.headerKey),void 0!==t.authKey&&null!==t.authKey&&""!==t.authKey.trim()&&e("#authkey"+a).val(t.authKey),void 0!==t.script&&null!==t.script&&e("#editor"+a).val(t.script));"narrator"===t.state?(e("#generator"+a).css({display:"none"}),e("#narrator"+a).css({display:"block"})):"generator"===t.state?(e("#narrator"+a).css({display:"none"}),e("#generator"+a).css({display:"block"})):""===t.state&&(e("#generator"+a).css({display:"none"}),e("#narrator"+a).css({display:"none"}))}(n,t);var o=parseInt(e("body").find("div[tid="+t.split("_")[1]+"]").height())-60;void 0!==o&&NaN!==o&&e("#narrator"+t).css({height:o+"px"});var s=".overlay,.pageloader{position:absolute;bottom:0;left:0;right:0}.overlay{width:100%;height:100vh;top:0;background:rgba(0,0,0,.51);z-index:999}.pageloader{width:60px;height:60px;top:50%;margin:0 auto;z-index:1000;background:url("+r+"arria/images/loader.gif) center no-repeat;background-size:cover;}";e("<style>").html(s).appendTo("head")}function d(t,a,l){try{var i=e("#narratorUrl"+t).val(),o="",s=e("#header"+t).val(),d=e("#authkey"+t).val(),c="",p={},u="";if(document.getElementById("loader"+t).style.display="block",c=""!==e("#jsbuilderoutput"+t).val()?e("#jsbuilderoutput"+t).val():e("#jsonholder"+t).val(),-1!==i.indexOf("studio.arria.com")){var h={id:"Primary",type:"json"};h.jsonData=JSON.parse(c),p.data=[],p.data.push(h),u=JSON.stringify(p)}else u=c;u=u.replace(/\s\s+/g," "),o=-1!==i.indexOf("studio.arria.com")?"arriaURL="+i+"&headername="+s+"&authKey="+d+"&appData="+encodeURIComponent(u)+"&biSource=qliksense":"Authorization"===s.value&&""!==d.value?"arriaURL="+i+"&headername="+s+"&authKey="+d+"&appData="+encodeURIComponent(u)+"&biSource=qliksense":"arriaURL="+i+"&appData="+encodeURIComponent(u)+"&biSource=qliksense",e.ajax({url:r+"arria/nlg",type:"post",data:o,contentType:"application/x-www-form-urlencoded",headers:{Authorization:"Basic "+n},success:function(r){if(e("#narrator"+t).hide(),r.type){if(-1!==r.data.indexOf("{color}")){var n=r.data.replace(/{color}/g,"</span>"),i=[];n.replace(/\{(.+?)}/g,function(e,t,a){i.push({label:t,key:e})});for(var o=0;o<i.length;o++)n=n.replace(i[o].key,'<span style="'+i[o].label+'">');e("#generator"+t).show().html(n),n}else e("#generator"+t).show().html(r.data),r.data;a.state="generator"}else{var s=r.error;""===r.data&&null===s&&(s="Narrative text not generated for your Dataset. Please check the input dataset."),e("#narrator"+t).hide(),e("#generator"+t).show().html(s),s}l.backendApi.setProperties(a),document.getElementById("loader"+t).style.display="none"},error:function(r){var n="";n=void 0!==r.error?r.error:r.statusText,e("#narrator"+t).hide(),e("#generator"+t).show().html(n),a.state="generator",l.backendApi.setProperties(a),document.getElementById("loader"+t).style.display="none"}})}catch(a){e("#overlay"+t).css({display:"none"}),e("#pageloader"+t).css({display:"none"}),document.getElementById("loader"+t).style.display="none"}}function c(t,a){e("#modaldata"+a).html(t),e("#model"+a).show(),e("#narratorUrl"+a).focus()}function p(t){var a=document.getElementById("initialTag"+t);null!==a&&a.parentNode.removeChild(a);var r=document.createElement("script");r.setAttribute("id","initialTag"+t),r.innerHTML="function getData(){var data=document.getElementById('jsonholder"+t+"').value;data=JSON.parse(data);return data;}function setData(data){document.getElementById('jsbuilderoutput"+t+"').value=JSON.stringify(data);}",e("body").append(r);var n=document.getElementById("editor"+t).value,l=document.getElementById("scripttag"+t);null!==l&&l.parentNode.removeChild(l);var i=document.createElement("script");i.setAttribute("id","scripttag"+t),i.innerHTML=n,e("body").append(i)}return{initialProperties:{qHyperCubeDef:{qDimensions:[],qMeasures:[],qInitialDataFetch:[{qWidth:10,qHeight:1e3}]}},definition:{type:"items",component:"accordion",items:{dimensions:{uses:"dimensions",min:1},measures:{uses:"measures",min:1},appearancePanel:{uses:"settings",items:{url:{ref:"url",type:"string",label:"Url",defaultValue:"",show:!1},auth:{ref:"headerKey",type:"string",label:"Header Key",defaultValue:"",show:!1},key:{ref:"authKey",type:"string",label:"Auth Key",defaultValue:"",show:!1},state:{ref:"state",type:"text",label:"Narrator State",defaultValue:"",show:!1},narrator:{ref:"narrator",type:"string",label:"Narrator Text",defaultValue:"",show:!1},script:{ref:"script",type:"string",label:"Script",defaultValue:"",show:!1},drillDown:{type:"items",label:"Drill Down Filter",items:{drillDownFilter:{ref:"drillDownFilter",type:"string",label:"Drill Down Key",defaultValue:"",show:!0},drillDownKey:{ref:"drillDownKey",type:"string",label:"Drill Down Fields",defaultValue:"",show:!0}}},fontSize:{type:"items",label:"Formatting Options",items:{narrativeFontSize:{ref:"narrativeFontSize",type:"number",component:"slider",min:10,max:36,step:1,defaultValue:13,label:"Text Size (10px - 36px)",show:!0}}},drillDownValue:{ref:"drillDownValue",type:"string",label:"Drill Down",defaultValue:"",show:!1}}}}},snapshot:{canTakeSnapshot:!1},paint:function(a,u){var h=this,y="",v={},f=u.drillDownFilter,g=u.drillDownKey,m=(u.drillDownValue,u.narrativeFontSize);(m<10||m>36)&&(u.narrativeFontSize=13,m=13);var b=u.qHyperCube,w=[],D=[],k=[],x=[],q=b.qSize.qcx,S=b.qSize.qcy,j=Math.floor(1e4/q),I=0;b.qDimensionInfo.forEach(function(e){w.push(e.qFallbackTitle)}),h.backendApi.getProperties().then(function(e){for(var t=e.qHyperCubeDef.qMeasures,a=0;a<t.length;a++){k.push(t[a].qDef.qDef);var r=t[a].qDef.qDef.split("(");if(-1!=(r=r[1].split(")"))[0].indexOf("[")){var n=r[0].split("[");n=n[1].split("]"),-1==w.indexOf(n[0])&&w.push(n[0])}else-1==w.indexOf(r[0])&&w.push(r[0])}}),function u(){var b=[{qTop:0,qLeft:0,qWidth:q,qHeight:Math.min(j,S-I)}];h.backendApi.getData(b).then(function(b){if(x=x.concat(b[0].qMatrix),(I+=b[0].qMatrix.length)<S&&I<=3e4)u();else{try{x.forEach(function(e){for(var t=[],a=0;a<e.length;a++){var r="";void 0!=e[a].qText&&"-"==(r=e[a].qText)&&(r=null),t.push(r)}D.push(t)})}catch(e){console.log(e)}v._id="1",v.source="qliksense",v.targetApp="",v.nlgApp="",v.chartType="",v.dataset=[];var q={metadata:{},drillDown:{}};q.measures=k,q.column_names=w,q.data=D,v.dataset.push(q),h.backendApi.getProperties().then(function(u){y="_"+u.qInfo.qId;var b=u;0===e("#qlikContainer"+y).length&&(s(y,a,b),e("#setting"+y).click(function(){i=!0,function(e,t,a){if("block"!==document.getElementById("loader"+e).style.display){var r=document.getElementById("narrator"+e),n=document.getElementById("generator"+e);"none"===r.style.display?(r.style.display="block",n.style.display="none",t.state="narrator"):(r.style.display="none",""!==n.innerHTML?(n.style.display="block",t.state="generator"):t.state=""),a.backendApi.setProperties(t)}}(y,b,h)}),e("#save"+y).click(function(){""!==e("#editor"+y).val()?(b.script=e("#editor"+y).val(),p(y)):(b.script="",e("#jsbuilderoutput"+y).val("")),""!==e("#narratorUrl"+y).val()?(l=!0,b.url=e("#narratorUrl"+y).val(),d(y,b,h)):c("Enter NLG Service URL",y),b.headerKey=e("#header"+y).val(),b.authKey=e("#authkey"+y).val(),h.backendApi.setProperties(b)}),e("#closemodal"+y).click(function(){e("#model"+y).hide(),e("#narratorUrl"+y).focus()}),e("#downloadJson"+y).click(function(){var t="";""!==document.getElementById("editor"+y).value?p(y):document.getElementById("jsbuilderoutput"+y).value="",t=""!==e("#jsbuilderoutput"+y).val()?"data="+encodeURIComponent(e("#jsbuilderoutput"+y).val()):"data="+encodeURIComponent(e("#jsonholder"+y).val()),e.ajax({url:r+"arria/savefile",type:"post",data:t,contentType:"application/x-www-form-urlencoded",headers:{Authorization:"Basic "+n},success:function(e){window.open(r+"arria/download?id="+e)},error:function(e){console.log(e)}})}));var w=parseInt(e(".qv-gridcell.active").height())-60;void 0!==w&&e("#narrator"+y).css({height:w+"px"});var D=a.height()-30;void 0!==D&&e("#generator"+y).css({height:D+"px"}),e("#generator"+y).css({"font-size":m+"px"}),e("#qlikContainer"+y).mouseover(function(){e("#headerLay"+y).css({display:"block"})}),e("#qlikContainer"+y).mouseleave(function(){e("#headerLay"+y).css({display:"none"})}),e("#editor"+y).change(function(){""===e(this).val()&&e("#jsbuilderoutput"+y).val("")}),e("#drillDownFilter"+y).change(function(){var t=document.getElementById("drillDownFilter"+y).value;v.dataset[0].drillDown[f]=t,e("#jsonholder"+y).val(JSON.stringify(v)),b.drillDownValue=t,h.backendApi.setProperties(b)}),function(){if(""!==f&&void 0!==f&&""!==g&&void 0!==g){e("#drillDownFilter"+y).show();var t=g.split(","),a=document.getElementById("drillDownFilter"+y);if(a.options.length=0,0!==t.length){for(var r=0;r<t.length;r++){var n=document.createElement("option");n.text=t[r],n.value=t[r],a.appendChild(n),""!==b.drillDownValue&&void 0!==b.drillDownValue&&t[r]==b.drillDownValue&&(a.selectedIndex=r)}v.dataset[0].drillDown[f]=a.value,e("#jsonholder"+y).val(JSON.stringify(v))}}else e("#jsonholder"+y).val(JSON.stringify(v)),e("#drillDownFilter"+y).hide()}(),function(){if("generator"===b.state){if(i)return i=!1,void(l&&(l=!1));if(""!==e("#editor"+y).val()&&p(y),""!==e("#narratorUrl"+y).val()){if(""!==e("#jsonholder"+y).val()){if(l)l=!1;else{var a=t.navigation.getMode();a!=o[y]?o[y]=a:"analysis"===a&&(e("#overlay"+y).css({display:"block"}),e("#pageloader"+y).css({display:"block"}))}d(y,b,h)}}else c("Enter NLG Service URL",y)}}()})}})}(),e(document).ajaxStop(function(){e("#loader"+y).css({display:"none"}),e("#overlay"+y).css({display:"none"}),e("#pageloader"+y).css({display:"none"})})}}});